name: Solicita√ß√£o de Acesso

on:
  issues:
   types: [ opened, edited ]

jobs:
  check_issue:
    runs-on: ubuntu-latest
    name: 'Verificar informa√ß√µes da Issue'
    steps:
      - id: checkout
        name: 'Checkout'
        uses: actions/checkout@v3
      - id: github_app_access_token
        name: 'GitHub App Access Token'
        uses: ./.github/actions/get_github_app_token
        with:
          app_id: ${{ secrets.APP_ID }}
          instalation_id: ${{ secrets.INSTALLATION_ID }}
          github_app_private_key: ${{ secrets.PRIVATE_KEY }}
      - id: dados_issue
        name: 'Dados da Issue'
        uses: actions/github-script@v6
        with:
          github-token: ${{ steps.github_app_access_token.outputs.ACCESS_TOKEN }}
          script: |
            const eventPayload = context.payload;
            const issueNumber = eventPayload.issue.number;
            const user = '${{ github.actor }}';
            const body = String(eventPayload.issue.body);
            const senha = body.replace('### Senha\n\n', '');

            const comentarioBody = 'Obrigado por abrir a issue, ' + user + 'üòÉ!';

            const comentarioIssueResponse = await github.rest.issues.createComment({
              owner: 'pedrogolino',
              repo: 'senac-devops-na-pratica',
              issue_number: issueNumber,
              body: comentarioBody
            });

            core.setCommandEcho(true);
            core.setOutput('USUARIO', user);
            core.setOutput('ISSUE', issueNumber);
            core.setCommandEcho(false);
            
            core.setOutput('SENHA', senha);
      - id: verificar_senha
        name: 'Verificar Senha'
        uses: actions/github-script@v6
        with:
          script: |
            if ('${{ steps.dados_issue.outputs.senha }}' == '${{ secrets.SENHA_SENAC }}' ) {
              console.log('Acesso OK');
              core.setOutput('ACESSO_OK', 'sim');
            } else { 
              console.log('Senha Incorreta');
              core.setOutput('ACESSO_OK', 'n√£o');
            }
      - id: incluir_usuario_org
        if: steps.verificar_senha.outputs.ACESSO_OK == 'sim'
        name: 'Incluir Usu√°rio na Organiza√ß√£o'
        uses: actions/github-script@v6
        with:
          github-token: ${{ steps.github_app_access_token.outputs.ACCESS_TOKEN }}
          script: |
            const user = '${{ github.actor }}';
            const issueNumber = '${{ steps.dados_issue.outputs.ISSUE }}';

            const userInfo = await github.rest.users.getByUsername({
              username: user
            });

            const comentarioIssueResponse = await github.rest.issues.createComment({
              owner: 'pedrogolino',
              repo: 'senac-devops-na-pratica',
              issue_number: issueNumber,
              body: 'Incluindo seu usu√°rio na Organiza√ß√£o. Verifique o convite enviado no e-mail: ' + userInfo.email + '.'
            });

            const incluirUsuarioOrgResponse = await github.rest.orgs.setMembershipForUser({
              org: 'pedrogolino',
              username: user
            });
      - id: incluir_usuario_time
        if: steps.verificar_senha.outputs.ACESSO_OK == 'sim'
        name: 'Incluir Usu√°rio no Time'
        uses: actions/github-script@v6
        with:
          github-token: ${{ steps.github_app_access_token.outputs.ACCESS_TOKEN }}
          script: |
            const teamName = '${{ secrets.TEAM_NAME }}';
            const user = '${{ github.actor }}';
            const issueNumber = '${{ steps.dados_issue.outputs.ISSUE }}';

            const comentarioIssueResponse = await github.rest.issues.createComment({
              owner: 'pedrogolino',
              repo: 'senac-devops-na-pratica',
              issue_number: issueNumber,
              body: 'Incluindo seu usu√°rio no time senac-lab.'
            });

            const incluirUsuarioTimeResponse = await github.rest.teams.addOrUpdateMembershipForUserInOrg({
              org: 'pedrogolino',
              team_slug: teamName,
              username: user,
              role: 'member'
            });
      - id: sucesso
        name: 'Sucesso'
        uses: actions/github-script@v6
        with:
          github-token: ${{ steps.github_app_access_token.outputs.ACCESS_TOKEN }}
          script: |
            const issueNumber = '${{ steps.dados_issue.outputs.ISSUE }}';

            const comentarioIssueResponse = await github.rest.issues.createComment({
              owner: 'pedrogolino',
              repo: 'senac-devops-na-pratica',
              issue_number: issueNumber,
              body: 'OnBoarding finalizado üöÄ'
            });

            const updateIssueResponse = await github.rest.issue.update({
              owner: 'pedrogolino',
              repo: 'senac-devops-na-pratica',
              issue_number: issueNumber,
              state: 'closed'
            });